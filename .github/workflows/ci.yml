name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options: [patch, minor, major]

permissions:
  contents: write

jobs:
  changes:
    uses: LevitateOS/LevitateOS/.github/workflows/detect-changes.yml@master
    with:
      type: rust

  ci:
    needs: changes
    if: needs.changes.outputs.has_changes == 'true'
    uses: LevitateOS/LevitateOS/.github/workflows/rust-ci.yml@master
    with:
      msrv: '1.93'
      extra-apt-packages: 'erofs-utils'
      smoke-test-script: |
        ./target/debug/recstrap --help
        ./target/debug/recstrap --version
        ./target/debug/recstrap /nonexistent 2>&1 | grep -q "E008"
        which mkfs.erofs

  # Project-specific E2E tests that can't be abstracted
  e2e-test:
    name: E2E Extraction Test
    needs: changes
    if: needs.changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y erofs-utils
      - run: cargo build --release

      - name: End-to-end extraction test
        run: |
          # Create test filesystem with essential directories
          mkdir -p test-root/{bin,etc,lib,sbin,usr,var}
          mkdir -p test-root/usr/{bin,lib,share}

          # Add test files with known content
          echo '#!/bin/sh' > test-root/bin/test-script
          echo 'echo hello' >> test-root/bin/test-script
          chmod +x test-root/bin/test-script
          echo 'test-config=value' > test-root/etc/test.conf
          echo 'NAME="TestOS"' > test-root/etc/os-release

          # Add a symlink (important for real systems)
          ln -s /usr/lib test-root/lib64

          # Create EROFS image (output first, source second)
          mkfs.erofs -T0 test.erofs test-root
          ls -la test.erofs

          # Create target directory
          mkdir -p /tmp/recstrap-test-target

          # Run recstrap (with sudo for root, --force to skip mount point check)
          sudo ./target/release/recstrap --force --rootfs test.erofs /tmp/recstrap-test-target

          # Verify essential directories exist
          test -d /tmp/recstrap-test-target/bin
          test -d /tmp/recstrap-test-target/etc
          test -d /tmp/recstrap-test-target/lib
          test -d /tmp/recstrap-test-target/sbin
          test -d /tmp/recstrap-test-target/usr
          test -d /tmp/recstrap-test-target/var

          # Verify test files were extracted correctly
          test -f /tmp/recstrap-test-target/bin/test-script
          test -x /tmp/recstrap-test-target/bin/test-script
          grep -q 'echo hello' /tmp/recstrap-test-target/bin/test-script

          test -f /tmp/recstrap-test-target/etc/test.conf
          grep -q 'test-config=value' /tmp/recstrap-test-target/etc/test.conf

          test -f /tmp/recstrap-test-target/etc/os-release
          grep -q 'NAME="TestOS"' /tmp/recstrap-test-target/etc/os-release

          # Verify symlink was preserved
          test -L /tmp/recstrap-test-target/lib64

          # Verify nested directories
          test -d /tmp/recstrap-test-target/usr/bin
          test -d /tmp/recstrap-test-target/usr/lib

          echo "E2E extraction test passed"

  release:
    needs: [changes, ci, e2e-test]
    if: |
      needs.changes.outputs.has_changes == 'true' &&
      ((github.event_name == 'push' && !startsWith(github.event.head_commit.message, 'chore: Bump version')) ||
      github.event_name == 'workflow_dispatch')
    uses: LevitateOS/LevitateOS/.github/workflows/rust-release.yml@master
    with:
      create-binary-artifact: true
      binary-name: 'recstrap'
    secrets:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
